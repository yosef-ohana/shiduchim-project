package com.example.myproject.service;

import com.example.myproject.model.*;
import com.example.myproject.repository.UserActionRepository;
import com.example.myproject.repository.UserRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
public class UserActionService {

    private final UserActionRepository userActionRepository;
    private final UserRepository userRepository;
    private final MatchService matchService;
    private final NotificationService notificationService;

    // =====================================================
    // ğŸ”µ Constructor
    // =====================================================

    public UserActionService(UserActionRepository userActionRepository,
                             UserRepository userRepository,
                             MatchService matchService,
                             NotificationService notificationService) {
        this.userActionRepository = userActionRepository;
        this.userRepository = userRepository;
        this.matchService = matchService;
        this.notificationService = notificationService;
    }

    // =====================================================
    // 1ï¸âƒ£ ×¢×–×¨: ×˜×¢×™× ×ª ××©×ª××©×™×
    // =====================================================

    private User loadUserOrThrow(Long userId, String messagePrefix) {
        if (userId == null) {
            throw new IllegalArgumentException(messagePrefix + " - userId is null");
        }
        return userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException(messagePrefix + userId));
    }

    // =====================================================
    // 2ï¸âƒ£ ××ª×•×“×ª ×œ×™×‘×”: ×™×¦×™×¨×ª UserAction ××—×ª
    // =====================================================

    /**
     * ××ª×•×“×” ×¤× ×™××™×ª ×©××™×™×¦×¨×ª UserAction ×•×©×•××¨×ª ××•×ª×•.
     * ××©××©×ª ××ª ×›×œ ×©××¨ ×”×¤×¢×•×œ×•×ª (LIKE/DISLIKE/FREEZE/VIEW ×•×›×•').
     */
    private UserAction recordActionInternal(Long actorId,
                                            Long targetUserId,
                                            Long weddingId,
                                            Long originWeddingId,
                                            Long matchId,
                                            UserActionType actionType,
                                            UserActionCategory categoryOverride,
                                            String metadata,
                                            String source,
                                            boolean autoGenerated,
                                            String listName,
                                            Long actionGroupId) {

        User actor = loadUserOrThrow(actorId, "Actor not found: ");

        User target = null;
        if (targetUserId != null) {
            target = loadUserOrThrow(targetUserId, "Target not found: ");
        }

        UserAction action = new UserAction();
        action.setActor(actor);
        action.setTarget(target);
        action.setActionType(actionType);

        // ×× ×œ× ××’×™×¢ override â€“ × ×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ×¤×™ ×˜×™×¤×•×¡
        UserActionCategory category = (categoryOverride != null)
                ? categoryOverride
                : UserActionCategory.SOCIAL;

        action.setCategory(category);
        action.setWeddingId(weddingId);
        action.setOriginWeddingId(originWeddingId);
        action.setMatchId(matchId);
        action.setActionGroupId(actionGroupId);
        action.setSource(source != null ? source : "user");
        action.setAutoGenerated(autoGenerated);
        action.setMetadata(metadata);
        action.setListName(listName);
        action.setActive(true);
        action.setCreatedAt(LocalDateTime.now());
        action.setUpdatedAt(LocalDateTime.now());

        return userActionRepository.save(action);
    }

    /**
     * ××ª×•×“×” ×’× ×¨×™×ª PUBLIC â€“ ×œ×©×™××•×© ××¦×“ ×§×•× ×˜×¨×•×œ×¨×™× / ×©×™×¨×•×ª×™× ××—×¨×™×.
     * ×–×”×” ×œÖ¾recordActionInternal ××‘×œ ×—×©×•×¤×” ×”×—×•×¦×”.
     */
    public UserAction recordUserAction(Long actorId,
                                       Long targetUserId,
                                       Long weddingId,
                                       Long originWeddingId,
                                       Long matchId,
                                       UserActionType actionType,
                                       UserActionCategory category,
                                       String metadata,
                                       String source,
                                       boolean autoGenerated,
                                       String listName,
                                       Long actionGroupId) {

        return recordActionInternal(
                actorId,
                targetUserId,
                weddingId,
                originWeddingId,
                matchId,
                actionType,
                category,
                metadata,
                source,
                autoGenerated,
                listName,
                actionGroupId
        );
    }

    // =====================================================================
    // 3ï¸âƒ£ ×©×œ×™×¤×•×ª ×‘×¡×™×¡×™×•×ª ×Ö¾UserActionRepository
    // =====================================================================

    @Transactional(readOnly = true)
    public List<UserAction> getActionsByActor(Long actorId) {
        return userActionRepository.findByActorId(actorId);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActiveActionsByActor(Long actorId) {
        return userActionRepository.findByActorIdAndActiveTrue(actorId);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActionsByTarget(Long targetId) {
        return userActionRepository.findByTargetId(targetId);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActiveActionsByTarget(Long targetId) {
        return userActionRepository.findByTargetIdAndActiveTrue(targetId);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActionsByType(UserActionType type) {
        return userActionRepository.findByActionType(type);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActionsByWedding(Long weddingId) {
        return userActionRepository.findByWeddingId(weddingId);
    }

    @Transactional(readOnly = true)
    public List<UserAction> getActionsByMatch(Long matchId) {
        return userActionRepository.findByMatchId(matchId);
    }

    // =====================================================================
    // 4ï¸âƒ£ ×¤×¢×•×œ×•×ª ××©×ª××©: LIKE / DISLIKE / FREEZE / UNFREEZE / VIEW
    // =====================================================================

    /**
     * ×œ×™×™×§ ×œ××©×ª××© ××—×¨.
     * - ×™×•×¦×¨ ×¤×¢×•×œ×” ××¡×•×’ LIKE
     * - ××¢×“×›×Ÿ listName = "LIKE"
     * - ××›×‘×” ×“×™×¡×œ×™×™×§/×§×¤×•× ×§×•×“××™×
     */
    public UserAction likeUser(Long actorId, Long targetUserId, Long weddingId) {

        if (actorId == null || targetUserId == null)
            throw new IllegalArgumentException("actorId and targetUserId are required");

        if (actorId.equals(targetUserId))
            throw new IllegalArgumentException("Cannot like yourself.");

        // ×ª×™×¢×•×“ ×”×¤×¢×•×œ×”
        UserAction action = recordActionInternal(
                actorId,
                targetUserId,
                weddingId,
                weddingId,                    // originWeddingId
                null,                         // matchId
                UserActionType.LIKE,
                UserActionCategory.SOCIAL,
                null,
                "user",
                false,
                "LIKE",
                null
        );

        // ×›×™×‘×•×™ ×¤×¢×•×œ×•×ª ×©×œ×™×œ×™×•×ª ×§×•×“××•×ª
        deactivatePreviousActions(actorId, targetUserId, UserActionType.DISLIKE);
        deactivatePreviousActions(actorId, targetUserId, UserActionType.FREEZE);

        return action;
    }

    /**
     * ×“×™×¡×œ×™×™×§ â€” ××‘×˜×œ ×œ×™×™×§ ×§×™×™× + ××¡××Ÿ ×›"×œ× ××¢×•× ×™×™×Ÿ".
     * - listName = "DISLIKE"
     * - ××›×‘×” LIKE ×§×•×“××™×
     * - ×©×•×œ×— ×”×ª×¨××” USER_DISLIKED ×œ×¦×“ ×”×©× ×™
     */
    public UserAction dislikeUser(Long actorId, Long targetUserId, Long weddingId) {

        UserAction action = recordActionInternal(
                actorId,
                targetUserId,
                weddingId,
                weddingId,
                null,
                UserActionType.DISLIKE,
                UserActionCategory.SOCIAL,
                null,
                "user",
                false,
                "DISLIKE",
                null
        );

        // ×›×™×‘×•×™ LIKE ×¤×¢×™×œ
        deactivatePreviousActions(actorId, targetUserId, UserActionType.LIKE);

        // ×©×œ×™×—×ª ×”×ª×¨××” (×œ×¤×™ ×”××¤×™×•×Ÿ)
        notificationService.notifyUserDisliked(targetUserId, actorId);

        return action;
    }

    /**
     * ×”×§×¤××ª ××©×ª××© â€” ×›× ×™×¡×” ×œ×¨×©×™××ª "××§×¤×™×".
     * - listName = "FREEZE"
     * - ××›×‘×” ×›×œ FREEZE ×§×•×“××™×
     * - ×©×•×œ×— ×”×ª×¨××” USER_FROZEN
     */
    public UserAction freezeUser(Long actorId, Long targetUserId, Long weddingId) {

        UserAction freeze = recordActionInternal(
                actorId,
                targetUserId,
                weddingId,
                weddingId,
                null,
                UserActionType.FREEZE,
                UserActionCategory.SOCIAL,
                null,
                "user",
                false,
                "FREEZE",
                null
        );

        // ×›×™×‘×•×™ FREEZE ×§×•×“××™×
        deactivatePreviousActions(actorId, targetUserId, UserActionType.FREEZE, freeze.getId());

        // ×”×ª×¨××”
        notificationService.notifyUserFreezeApplied(targetUserId, actorId);

        return freeze;
    }

    /**
     * ×‘×™×˜×•×œ ×§×¤×™××” â€” UNFREEZE
     * - ××¡×™×¨ ×›×œ FREEZE ×¤×¢×™×œ×™×
     * - listName = "UNFREEZE" (×¨×§ ×”×™×¡×˜×•×¨×™×”)
     * - ×©×•×œ×— ×”×ª×¨××” USER_UNFROZEN
     */
    public UserAction unfreezeUser(Long actorId, Long targetUserId) {

        // ×›×™×‘×•×™ FREEZE ×¤×¢×™×œ
        deactivatePreviousActions(actorId, targetUserId, UserActionType.FREEZE);

        // ×ª×™×¢×•×“ UNFREEZE
        UserAction action = recordActionInternal(
                actorId,
                targetUserId,
                null,
                null,
                null,
                UserActionType.UNFREEZE,
                UserActionCategory.SOCIAL,
                null,
                "user",
                false,
                "UNFREEZE",
                null
        );

        notificationService.notifyUserUnfreezeApplied(targetUserId, actorId);

        return action;
    }

    /**
     * ×¦×¤×™×™×” ×‘×¤×¨×•×¤×™×œ â€” VIEW
     * - listName = "VIEW"
     * - ××©×ª××©×™× ×‘×¡×˜×˜×™×¡×˜×™×§×” ×œ×¦×¤×™×•×ª ×‘×¤×¨×•×¤×™×œ (SUMMARY)
     */
    public UserAction viewProfile(Long actorId, Long targetUserId, Long weddingId) {

        return recordActionInternal(
                actorId,
                targetUserId,
                weddingId,
                weddingId,
                null,
                UserActionType.VIEW,
                UserActionCategory.SOCIAL,
                null,
                "user",
                false,
                "VIEW",
                null
        );
    }

    // =====================================================================
    // 5ï¸âƒ£ ×¢×–×¨: ×›×™×‘×•×™ ×¤×¢×•×œ×•×ª ×§×•×“××•×ª
    // =====================================================================

    /**
     * ××›×‘×” (active=false) ×¤×¢×•×œ×” ×§×•×“××ª ×××•×ª×• ×¡×•×’ ×‘×™×Ÿ ××•×ª× ××©×ª××©×™×.
     */
    private void deactivatePreviousActions(Long actorId,
                                           Long targetId,
                                           UserActionType type) {

        User actor = loadUserOrThrow(actorId, "Actor not found: ");
        User target = loadUserOrThrow(targetId, "Target not found: ");

        userActionRepository.findByActorAndTarget(actor, target)
                .stream()
                .filter(a -> a.isActive() && a.getActionType() == type)
                .forEach(a -> {
                    a.setActive(false);
                    a.setUpdatedAt(LocalDateTime.now());
                    userActionRepository.save(a);
                });
    }

    /**
     * ×›×™×‘×•×™ ×§×•×“××™× ×¤×¨×˜ ×œ×¤×¢×•×œ×” ×©×›×¨×’×¢ × ×•×¦×¨×”.
     */
    private void deactivatePreviousActions(Long actorId,
                                           Long targetId,
                                           UserActionType type,
                                           Long excludeId) {

        User actor = loadUserOrThrow(actorId, "Actor not found: ");
        User target = loadUserOrThrow(targetId, "Target not found: ");

        userActionRepository.findByActorAndTarget(actor, target)
                .stream()
                .filter(a -> !a.getId().equals(excludeId))
                .filter(a -> a.isActive() && a.getActionType() == type)
                .forEach(a -> {
                    a.setActive(false);
                    a.setUpdatedAt(LocalDateTime.now());
                    userActionRepository.save(a);
                });
    }

    // =====================================================================
    // 6ï¸âƒ£ ×¨×©×™××•×ª ×œ×¤×™ listName (LIKE / DISLIKE / FREEZE / VIEW)
    // =====================================================================

    /**
     * ×›×œ ×”×¤×¢×•×œ×•×ª ×”×¤×¢×™×œ×•×ª ×©×œ ××©×ª××© ×‘×¨×©×™××” ××¡×•×™××ª (LIKE / DISLIKE / FREEZE / VIEW ×•×›×•').
     */
    @Transactional(readOnly = true)
    public List<UserAction> getListForUser(Long actorId, String listName) {
        return userActionRepository.findByActorIdAndListName(actorId, listName)
                .stream()
                .filter(UserAction::isActive)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<UserAction> getMyLikes(Long actorId) {
        return getListForUser(actorId, "LIKE");
    }

    @Transactional(readOnly = true)
    public List<UserAction> getMyDislikes(Long actorId) {
        return getListForUser(actorId, "DISLIKE");
    }

    @Transactional(readOnly = true)
    public List<UserAction> getMyFreezes(Long actorId) {
        return getListForUser(actorId, "FREEZE");
    }

    @Transactional(readOnly = true)
    public List<UserAction> getMyProfileViews(Long actorId) {
        return getListForUser(actorId, "VIEW");
    }

    // =====================================================================
    // 7ï¸âƒ£ ×¡×™×›×•× ×¦×¤×™×•×ª ×‘×¤×¨×•×¤×™×œ (×œ×¤×™ ××¤×™×•×Ÿ 2025 + NotificationService)
    // =====================================================================

    /**
     * ×¡×¤×™×¨×ª ×¦×¤×™×•×ª ×‘×¤×¨×•×¤×™×œ ×©×œ ××©×ª××© ×‘×ª×§×•×¤×” ××¡×•×™××ª.
     * ××©×ª××© ×‘Ö¾findByCreatedAtBetween ×•××– ××¡× ×Ÿ ×‘-Java.
     */
    @Transactional(readOnly = true)
    public int countProfileViewsForUserInPeriod(Long userId,
                                                LocalDateTime from,
                                                LocalDateTime to) {

        List<UserAction> allInPeriod =
                userActionRepository.findByCreatedAtBetween(from, to);

        return (int) allInPeriod.stream()
                .filter(a -> a.getTarget() != null
                        && a.getTarget().getId().equals(userId)
                        && a.getActionType() == UserActionType.VIEW)
                .count();
    }

    /**
     * ×™×¦×™×¨×ª ×”×ª×¨××ª ×¡×™×›×•× ×¦×¤×™×•×ª ×‘×¤×¨×•×¤×™×œ ×œ××©×ª××© (×©×™××•×© ×‘-NotificationService).
     */
    public void sendProfileViewsSummary(Long userId,
                                        String periodLabel,
                                        LocalDateTime from,
                                        LocalDateTime to) {

        int views = countProfileViewsForUserInPeriod(userId, from, to);
        notificationService.notifyProfileViewsSummary(userId, periodLabel, views);
    }
}